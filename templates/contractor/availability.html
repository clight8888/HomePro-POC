{% extends "base.html" %}

{% block title %}Availability Calendar - HomePro{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Availability Calendar
                    </h4>
                    <div>
                        <a href="{{ url_for('contractor_profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-user me-2"></i>
                            Back to Profile
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <p class="text-muted">
                                Manage your availability to help homeowners know when you're free for new projects. 
                                Click on any date to update your status.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <div class="availability-legend">
                                <div class="legend-item">
                                    <span class="legend-color available"></span>
                                    <span>Available</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color busy"></span>
                                    <span>Busy</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color unavailable"></span>
                                    <span>Unavailable</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="calendar-container">
                        <div class="calendar-navigation mb-3">
                            <button class="btn btn-outline-primary" id="prevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h5 class="calendar-title mx-3 mb-0" id="calendarTitle"></h5>
                            <button class="btn btn-outline-primary" id="nextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Availability Modal -->
<div class="modal fade" id="availabilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Availability</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="availabilityForm">
                    <input type="hidden" id="selectedDate" name="date">
                    
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="text" class="form-control" id="dateDisplay" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="available">Available</option>
                            <option value="busy">Busy</option>
                            <option value="unavailable">Unavailable</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Add any notes about your availability..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAvailability">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
class AvailabilityCalendar {
    constructor() {
        this.currentDate = new Date();
        this.availability = {};
        this.loadAvailability();
        this.initializeCalendar();
        this.bindEvents();
    }
    
    loadAvailability() {
        // Convert server data to JavaScript object
        const availabilityData = {{ availability | tojson }};
        availabilityData.forEach(item => {
            this.availability[item.available_date] = {
                status: item.status,
                notes: item.notes
            };
        });
    }
    
    initializeCalendar() {
        this.renderCalendar();
    }
    
    bindEvents() {
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.renderCalendar();
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.renderCalendar();
        });
        
        document.getElementById('saveAvailability').addEventListener('click', () => {
            this.saveAvailability();
        });
    }
    
    renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        // Update title
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Create calendar grid
        let calendarHTML = '<div class="calendar-header">';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });
        calendarHTML += '</div><div class="calendar-body">';
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDayOfWeek; i++) {
            calendarHTML += '<div class="calendar-day empty"></div>';
        }
        
        // Add days of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateString = date.toISOString().split('T')[0];
            const isPast = date < today.setHours(0, 0, 0, 0);
            
            let dayClass = 'calendar-day';
            let statusClass = '';
            
            if (isPast) {
                dayClass += ' past';
            }
            
            if (this.availability[dateString]) {
                statusClass = this.availability[dateString].status;
            }
            
            calendarHTML += `
                <div class="calendar-day ${dayClass} ${statusClass}" 
                     data-date="${dateString}" 
                     ${!isPast ? 'onclick="calendar.openAvailabilityModal(\'' + dateString + '\')"' : ''}>
                    <span class="day-number">${day}</span>
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        document.getElementById('calendarGrid').innerHTML = calendarHTML;
    }
    
    openAvailabilityModal(dateString) {
        const date = new Date(dateString);
        const formattedDate = date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        document.getElementById('selectedDate').value = dateString;
        document.getElementById('dateDisplay').value = formattedDate;
        
        // Set current values if they exist
        if (this.availability[dateString]) {
            document.getElementById('status').value = this.availability[dateString].status;
            document.getElementById('notes').value = this.availability[dateString].notes || '';
        } else {
            document.getElementById('status').value = 'available';
            document.getElementById('notes').value = '';
        }
        
        const modal = new bootstrap.Modal(document.getElementById('availabilityModal'));
        modal.show();
    }
    
    saveAvailability() {
        const form = document.getElementById('availabilityForm');
        const formData = new FormData(form);
        const data = {
            date: formData.get('date'),
            status: formData.get('status'),
            notes: formData.get('notes')
        };
        
        const saveBtn = document.getElementById('saveAvailability');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        fetch('{{ url_for("update_contractor_availability") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update local availability data
                this.availability[data.date] = {
                    status: data.status,
                    notes: data.notes
                };
                
                // Re-render calendar
                this.renderCalendar();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('availabilityModal'));
                modal.hide();
                
                // Show success message
                this.showAlert('success', result.message);
            } else {
                this.showAlert('danger', result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            this.showAlert('danger', 'An error occurred while updating availability.');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        });
    }
    
    showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
}

// Initialize calendar when page loads
let calendar;
document.addEventListener('DOMContentLoaded', function() {
    calendar = new AvailabilityCalendar();
});
</script>

<style>
.availability-legend {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid #ddd;
}

.legend-color.available {
    background-color: #d4edda;
    border-color: #28a745;
}

.legend-color.busy {
    background-color: #fff3cd;
    border-color: #ffc107;
}

.legend-color.unavailable {
    background-color: #f8d7da;
    border-color: #dc3545;
}

.calendar-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
}

.calendar-grid {
    max-width: 800px;
    margin: 0 auto;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    margin-bottom: 1px;
}

.calendar-day-header {
    background-color: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    border: 1px solid #dee2e6;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
}

.calendar-day {
    min-height: 60px;
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.calendar-day:not(.past):not(.empty):hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-day.empty {
    background-color: #f8f9fa;
    cursor: default;
}

.calendar-day.past {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: default;
}

.calendar-day.available {
    background-color: #d4edda;
    border-color: #28a745;
}

.calendar-day.busy {
    background-color: #fff3cd;
    border-color: #ffc107;
}

.calendar-day.unavailable {
    background-color: #f8d7da;
    border-color: #dc3545;
}

.day-number {
    font-weight: 600;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .calendar-day {
        min-height: 50px;
        padding: 0.25rem;
    }
    
    .calendar-day-header {
        padding: 0.5rem 0.25rem;
        font-size: 0.9rem;
    }
    
    .day-number {
        font-size: 1rem;
    }
    
    .availability-legend {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
}
</style>
{% endblock %}