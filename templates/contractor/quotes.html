{% extends "base.html" %}

{% block title %}Professional Quotes - HomePro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Professional Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <h3 class="mb-1 fw-bold text-dark"><i class="fas fa-file-contract me-2"></i>Professional Quotes</h3>
                    <p class="mb-0 text-muted small">Create, manage, and send professional quotes to your clients</p>
                </div>
                <div>
                    <a href="{{ url_for('contractor_profile') }}" class="btn btn-outline-secondary btn-sm me-2">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </a>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createQuoteModal">
                        <i class="fas fa-plus me-1"></i>New Quote
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                    <h4 class="fw-bold">{{ quotes|length }}</h4>
                    <p class="text-muted mb-0">Total Quotes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-paper-plane fa-2x text-info mb-2"></i>
                    <h4 class="fw-bold">{{ quotes|selectattr('status', 'equalto', 'sent')|list|length }}</h4>
                    <p class="text-muted mb-0">Sent Quotes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h4 class="fw-bold">{{ quotes|selectattr('status', 'equalto', 'accepted')|list|length }}</h4>
                    <p class="text-muted mb-0">Accepted</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
                    <h4 class="fw-bold">${{ "%.0f"|format(quotes|sum(attribute='final_amount') or 0) }}</h4>
                    <p class="text-muted mb-0">Total Value</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Quotes List -->
    <div class="row">
        <div class="col-12">
            {% if quotes %}
                <div class="card border-0 shadow">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 fw-bold text-dark"><i class="fas fa-list-alt me-2 text-primary"></i>Your Professional Quotes</h4>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                                    <option value="">All Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="expired">Expired</option>
                                </select>
                                <input type="text" class="form-control form-control-sm" id="searchQuotes" placeholder="Search quotes..." style="width: 200px;">
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="fw-bold">Quote #</th>
                                        <th class="fw-bold">Project Details</th>
                                        <th class="fw-bold">Client Information</th>
                                        <th class="fw-bold">Amount</th>
                                        <th class="fw-bold">Status</th>
                                        <th class="fw-bold">Valid Until</th>
                                        <th class="fw-bold">Created</th>
                                        <th class="fw-bold text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="quotesTableBody">
                                    {% for quote in quotes %}
                                    <tr class="quote-row" data-status="{{ quote.status }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
                                                    #
                                                </div>
                                                <strong class="text-primary fs-6">{{ quote.quote_number }}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong class="text-dark">{{ quote.project_title }}</strong>
                                                <br>
                                                <small class="text-muted"><i class="fas fa-tag me-1"></i>{{ quote.title }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong class="text-dark"><i class="fas fa-user me-1"></i>{{ quote.client_name }}</strong>
                                                <br>
                                                <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>{{ quote.client_location }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-end">
                                                <strong class="text-success fs-5">${{ "%.2f"|format(quote.final_amount) }}</strong>
                                                {% if quote.tax_amount > 0 %}
                                                    <br><small class="text-muted">+${{ "%.2f"|format(quote.tax_amount) }} tax</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if quote.status == 'draft' %}
                                                <span class="badge bg-secondary px-3 py-2"><i class="fas fa-edit me-1"></i>Draft</span>
                                            {% elif quote.status == 'sent' %}
                                                <span class="badge bg-primary px-3 py-2"><i class="fas fa-paper-plane me-1"></i>Sent</span>
                                            {% elif quote.status == 'accepted' %}
                                                <span class="badge bg-success px-3 py-2"><i class="fas fa-check-circle me-1"></i>Accepted</span>
                                            {% elif quote.status == 'rejected' %}
                                                <span class="badge bg-danger px-3 py-2"><i class="fas fa-times-circle me-1"></i>Rejected</span>
                                            {% elif quote.status == 'expired' %}
                                                <span class="badge bg-warning px-3 py-2"><i class="fas fa-clock me-1"></i>Expired</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if quote.valid_until %}
                                                <div class="text-center">
                                                    <strong>{{ quote.valid_until.strftime('%m/%d/%Y') }}</strong>
                                                    <br><small class="text-muted">{{ quote.valid_until.strftime('%b %d') }}</small>
                                                </div>
                                            {% else %}
                                                <span class="text-muted text-center d-block"><i class="fas fa-infinity"></i><br>No expiry</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="text-center">
                                                <strong>{{ quote.created_at.strftime('%m/%d/%Y') }}</strong>
                                                <br><small class="text-muted">{{ quote.created_at.strftime('%I:%M %p') }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex justify-content-center gap-1">
                                                <button class="btn btn-sm btn-outline-primary" title="View/Edit Quote" data-bs-toggle="tooltip" onclick="viewEditQuote({{ quote.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {% if quote.status == 'draft' %}
                                                    <button class="btn btn-sm btn-outline-success" title="Send Quote to Client" data-bs-toggle="tooltip" onclick="sendQuote({{ quote.id }})">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info" title="Download PDF" data-bs-toggle="tooltip" onclick="downloadQuotePDF({{ quote.id }})">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                {% if quote.status in ['draft', 'sent'] %}
                                                    <button class="btn btn-sm btn-outline-danger" title="Delete Quote" data-bs-toggle="tooltip" onclick="deleteQuote({{ quote.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="card border-0 shadow">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-file-contract fa-4x text-primary opacity-50"></i>
                        </div>
                        <h3 class="fw-bold text-dark mb-3">Ready to Create Professional Quotes?</h3>
                        <p class="text-muted mb-4 fs-5">Start building your business with professional quotes that impress clients and win projects.</p>
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-primary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#createQuoteModal">
                                <i class="fas fa-plus-circle me-2"></i>Create Your First Quote
                            </button>
                        </div>
                        <div class="mt-4">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Tip: Professional quotes help you win more projects and build trust with clients
                            </small>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Quote Modal -->
<div class="modal fade" id="createQuoteModal" tabindex="-1" aria-labelledby="createQuoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title fw-bold" id="createQuoteModalLabel">
                    <i class="fas fa-file-contract me-2"></i>Create Professional Quote
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('create_quote') }}">
                <div class="modal-body p-4">
                    <!-- Project Selection Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold text-primary">
                                <i class="fas fa-home me-2"></i>Project Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="project_id" class="form-label fw-semibold">Select Project *</label>
                                        <select class="form-control" id="project_id" name="project_id" required>
                                            <option value="">Choose from your bid projects...</option>
                                            <!-- Only projects the contractor has bid on will be populated here -->
                                        </select>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Only projects you've submitted bids for are shown
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="quote_title" class="form-label fw-semibold">Quote Title *</label>
                                        <input type="text" class="form-control" id="quote_title" name="title" 
                                               placeholder="e.g., Kitchen Renovation Quote" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quote Description Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold text-primary">
                                <i class="fas fa-file-alt me-2"></i>Quote Description
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="quote_description" class="form-label fw-semibold">Work Description *</label>
                                <textarea class="form-control" id="quote_description" name="description" rows="4" 
                                          placeholder="Provide a detailed description of the work to be performed..." required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Breakdown Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold text-primary">
                                <i class="fas fa-calculator me-2"></i>Cost Breakdown
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="labor_cost" class="form-label fw-semibold">
                                            <i class="fas fa-users me-1"></i>Labor Cost
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="labor_cost" name="labor_cost" 
                                                   min="0" step="0.01" value="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="materials_cost" class="form-label fw-semibold">
                                            <i class="fas fa-tools me-1"></i>Materials Cost
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="materials_cost" name="materials_cost" 
                                                   min="0" step="0.01" value="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="other_costs" class="form-label fw-semibold">
                                            <i class="fas fa-plus-circle me-1"></i>Other Costs
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="other_costs" name="other_costs" 
                                                   min="0" step="0.01" value="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tax_rate" class="form-label fw-semibold">
                                            <i class="fas fa-percentage me-1"></i>Tax Rate (%)
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="tax_rate" name="tax_rate" 
                                                   min="0" max="100" step="0.01" value="0" placeholder="0.00">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="valid_until" class="form-label fw-semibold">
                                            <i class="fas fa-calendar-alt me-1"></i>Valid Until *
                                        </label>
                                        <input type="date" class="form-control" id="valid_until" name="valid_until" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total Amount Display -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card bg-light border">
                                        <div class="card-body text-center py-2">
                                            <h5 class="mb-0 fw-bold text-primary">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                Total Amount: $<span id="totalAmount">0.00</span>
                                            </h5>
                                            <small class="text-muted">Including all costs and taxes</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold text-primary">
                                <i class="fas fa-sticky-note me-2"></i>Additional Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="quote_notes" class="form-label fw-semibold">Terms & Conditions</label>
                                <textarea class="form-control" id="quote_notes" name="notes" rows="3" 
                                          placeholder="Payment terms, warranty information, project timeline, etc..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light border-0 p-4">
                <div class="d-flex justify-content-between w-100">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary px-4" onclick="saveDraft()">
                            <i class="fas fa-save me-2"></i>Save as Draft
                        </button>
                        <button type="button" class="btn btn-primary px-4" onclick="createAndSendQuote()">
                            <i class="fas fa-paper-plane me-2"></i>Create & Send Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate total amount including tax
function calculateTotal() {
    const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
    const materialsCost = parseFloat(document.getElementById('materials_cost').value) || 0;
    const otherCost = parseFloat(document.getElementById('other_costs').value) || 0;
    const taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
    
    const subtotal = laborCost + materialsCost + otherCost;
    const tax = subtotal * (taxRate / 100);
    const total = subtotal + tax;
    
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Load projects that contractor has bid on
function loadProjectsWithBids() {
    fetch('/api/contractor/projects_with_bids')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const projectSelect = document.getElementById('project_id');
                projectSelect.innerHTML = '<option value="">Select a project...</option>';
                
                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.title} - ${project.homeowner_name}`;
                    projectSelect.appendChild(option);
                });
            } else {
                console.error('Failed to load projects:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading projects:', error);
        });
}

// Save quote as draft
function saveDraft() {
    createQuote('draft');
}

// Create and send quote
function createAndSendQuote() {
    createQuote('sent');
}

// Create quote function
function createQuote(status) {
    const formData = {
        project_id: document.getElementById('project_id').value,
        title: document.getElementById('quote_title').value,
        description: document.getElementById('quote_description').value,
        cost_breakdown: {
            materials: parseFloat(document.getElementById('materials_cost').value) || 0,
            labor: parseFloat(document.getElementById('labor_cost').value) || 0,
            permits: 0, // Add permits field if needed
            other: parseFloat(document.getElementById('other_costs').value) || 0
        },
        additional_info: document.getElementById('quote_notes').value,
        valid_until: document.getElementById('valid_until').value,
        status: status
    };
    
    // Validate required fields
    if (!formData.project_id || !formData.description || !formData.title) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('/api/contractor/create_quote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('createQuoteModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating quote:', error);
        alert('An error occurred while creating the quote.');
    });
}

// Initialize tooltips and set default dates
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Set default valid until date (30 days from now)
    const validUntilInput = document.getElementById('valid_until');
    if (validUntilInput) {
        const today = new Date();
        today.setDate(today.getDate() + 30);
        validUntilInput.value = today.toISOString().split('T')[0];
    }
    
    // Add event listeners for cost calculation
    const costInputs = ['labor_cost', 'materials_cost', 'other_costs', 'tax_rate'];
    costInputs.forEach(function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', calculateTotal);
        }
    });
    
    // Initialize total calculation
    calculateTotal();
    
    // Add event listeners for filtering and searching
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterQuotes);
    }
    
    const searchInput = document.getElementById('searchQuotes');
    if (searchInput) {
        searchInput.addEventListener('input', searchQuotes);
    }
    
    // Load projects when create quote modal is opened
    const createQuoteModal = document.getElementById('createQuoteModal');
    if (createQuoteModal) {
        createQuoteModal.addEventListener('show.bs.modal', function() {
            loadProjectsWithBids();
        });
    }
    
    // Event listeners are handled by onclick attributes in HTML
});

// Filter quotes by status
function filterQuotes() {
    const filter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('.quote-row');
    
    rows.forEach(function(row) {
        if (filter === '') {
            row.style.display = '';
        } else {
            const status = row.getAttribute('data-status');
            row.style.display = status === filter ? '' : 'none';
        }
    });
}

// Search quotes
function searchQuotes() {
    const searchTerm = document.getElementById('searchQuotes').value.toLowerCase();
    const rows = document.querySelectorAll('.quote-row');
    
    rows.forEach(function(row) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// View/Edit Quote
function viewEditQuote(quoteId) {
    // Redirect to quote edit page or open modal
    window.location.href = `/contractor/quotes/${quoteId}/edit`;
}

// Send Quote to Client
function sendQuote(quoteId) {
    if (confirm('Are you sure you want to send this quote to the client?')) {
        fetch(`/api/contractor/quotes/${quoteId}/send`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Quote sent successfully!');
                location.reload();
            } else {
                alert('Error sending quote: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error sending quote');
        });
    }
}

// Download Quote PDF
function downloadQuotePDF(quoteId) {
    // Create a temporary link to download the PDF
    const link = document.createElement('a');
    link.href = `/api/contractor/quotes/${quoteId}/pdf`;
    link.download = `quote_${quoteId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Delete Quote
function deleteQuote(quoteId) {
    if (confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
        fetch(`/api/contractor/quotes/${quoteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Quote deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting quote: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting quote');
        });
    }
}
</script>
{% endblock %}