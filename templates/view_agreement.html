{% extends "base.html" %}

{% block title %}Project Agreement{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-contract text-primary me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h2 class="mb-1">Project Agreement</h2>
                                <p class="text-muted mb-0">{{ agreement.project_title }}</p>
                            </div>
                        </div>
                        
                        <!-- Status Badge -->
                        <div>
                            {% if agreement.status == 'draft' %}
                                <span class="badge bg-secondary fs-6"><i class="fas fa-edit me-1"></i>Draft</span>
                            {% elif agreement.status == 'partially_signed' %}
                                <span class="badge bg-warning fs-6"><i class="fas fa-clock me-1"></i>Partially Signed</span>
                            {% elif agreement.status == 'signed' %}
                                <span class="badge bg-success fs-6"><i class="fas fa-check-circle me-1"></i>Fully Executed</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Agreement Info -->
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Created:</strong></p>
                            <p class="text-muted">{{ agreement.created_at.strftime('%B %d, %Y') if agreement.created_at else 'N/A' }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Start Date:</strong></p>
                            <p class="text-muted">{{ agreement.start_date or 'Not specified' }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Completion Date:</strong></p>
                            <p class="text-muted">{{ agreement.completion_date or 'Not specified' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signature Status -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-signature text-primary me-2"></i>Signature Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                {% if agreement.homeowner_signed_at %}
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <div>
                                        <strong>Homeowner Signed</strong>
                                        <div class="small text-muted">
                                            {{ agreement.homeowner_signature }}<br>
                                            {{ agreement.homeowner_signed_at.strftime('%B %d, %Y at %I:%M %p') if agreement.homeowner_signed_at else '' }}
                                        </div>
                                    </div>
                                {% else %}
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <div>
                                        <strong>Homeowner Signature Pending</strong>
                                        <div class="small text-muted">Waiting for homeowner to sign</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                {% if agreement.contractor_signed_at %}
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <div>
                                        <strong>Contractor Signed</strong>
                                        <div class="small text-muted">
                                            {{ agreement.contractor_signature }}<br>
                                            {{ agreement.contractor_signed_at.strftime('%B %d, %Y at %I:%M %p') if agreement.contractor_signed_at else '' }}
                                        </div>
                                    </div>
                                {% else %}
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <div>
                                        <strong>Contractor Signature Pending</strong>
                                        <div class="small text-muted">Waiting for contractor to sign</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agreement Content -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt text-primary me-2"></i>Agreement Terms</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="printAgreement()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
                <div class="card-body">
                    <div id="agreementContent" class="agreement-content">
                        <pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">{{ agreement.agreement_content }}</pre>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('view_project', project_id=agreement.project_id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Project
                        </a>
                        
                        <div>
                            {% if agreement.status != 'signed' %}
                                <!-- Sign Button -->
                                {% if is_homeowner and not agreement.homeowner_signed_at %}
                                    <button class="btn btn-success" onclick="signAgreement()">
                                        <i class="fas fa-signature me-2"></i>Sign as Homeowner
                                    </button>
                                {% elif is_contractor and not agreement.contractor_signed_at %}
                                    <button class="btn btn-success" onclick="signAgreement()">
                                        <i class="fas fa-signature me-2"></i>Sign as Contractor
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check-circle me-1"></i>Agreement Fully Executed
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Signature Confirmation Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-signature me-2"></i>Sign Agreement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Important:</strong> By signing this agreement, you are legally committing to the terms and conditions outlined above.
                </div>
                
                <p>Please confirm that you have read and agree to all terms in this project agreement.</p>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmTerms" required>
                    <label class="form-check-label" for="confirmTerms">
                        I have read and agree to all terms and conditions in this agreement
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSignBtn" disabled>
                    <i class="fas fa-signature me-2"></i>Sign Agreement
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.agreement-content {
    background-color: #fafafa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin: 0;
}

@media print {
    .container {
        max-width: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .btn, .modal, .card-header {
        display: none !important;
    }
    
    .agreement-content {
        background-color: white !important;
        border: none !important;
        padding: 0 !important;
    }
}
</style>

<script>
$(document).ready(function() {
    // Enable/disable sign button based on checkbox
    $('#confirmTerms').change(function() {
        $('#confirmSignBtn').prop('disabled', !this.checked);
    });
    
    // Handle sign button click
    $('#confirmSignBtn').click(function() {
        if (!$('#confirmTerms').is(':checked')) {
            alert('Please confirm that you agree to the terms.');
            return;
        }
        
        // Disable button to prevent double-clicking
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Signing...');
        
        // Submit signature
        fetch(`/sign_agreement/{{ agreement.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#signatureModal').modal('hide');
                
                // Show success message
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('.container').prepend(alertHtml);
                
                // Reload page after a short delay to show updated signatures
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                alert('Error: ' + data.message);
                $('#confirmSignBtn').prop('disabled', false).html('<i class="fas fa-signature me-2"></i>Sign Agreement');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while signing the agreement.');
            $('#confirmSignBtn').prop('disabled', false).html('<i class="fas fa-signature me-2"></i>Sign Agreement');
        });
    });
});

function signAgreement() {
    $('#signatureModal').modal('show');
}

function printAgreement() {
    window.print();
}
</script>
{% endblock %}